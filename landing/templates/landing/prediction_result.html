{% extends 'landing/base_with_sidebar.html' %}

{% block title %}ML Model Analysis Result - Fraud Detection System{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-8">
    <!-- Hero Result Banner -->
    <div class="relative overflow-hidden rounded-2xl shadow-xl border border-gray-200">
        <div class="absolute inset-0 opacity-10 {% if result == 'Fraud' %}bg-[radial-gradient(circle_at_top_left,_#ef4444,_transparent_50%)]{% else %}bg-[radial-gradient(circle_at_top_left,_#10b981,_transparent_50%)]{% endif %}"></div>
        <div class="relative {% if result == 'Fraud' %}bg-gradient-to-r from-red-500 to-rose-600{% else %}bg-gradient-to-r from-green-500 to-emerald-600{% endif %} p-8 text-white">
            <div class="flex flex-col lg:flex-row items-center justify-between gap-6">
                    <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center">
                            {% if result == 'Fraud' %}
                                <i class="fas fa-exclamation-triangle text-3xl"></i>
                            {% else %}
                                <i class="fas fa-check-circle text-3xl"></i>
                            {% endif %}
                        </div>
                        <div>
                        <h2 class="text-3xl font-extrabold tracking-tight">
                            {% if result == 'Fraud' %}Fraud Detected{% else %}No Fraud Detected{% endif %}
                            </h2>
                        <p class="text-white/90 mt-2 max-w-2xl">
                                {% if result == 'Fraud' %}
                                This claim shows multiple high-risk indicators and requires immediate attention.
                                {% else %}
                                This claim appears legitimate and can proceed with standard processing.
                                {% endif %}
                            </p>
                        </div>
                    </div>
                <div class="flex items-center gap-6">
                    <div class="text-center">
                        <div class="text-4xl font-extrabold">{{ processing_time|floatformat:3|default:"0.234" }}s</div>
                        <div class="text-xs text-white/80">Processing Time</div>
                    </div>
                    <div class="w-28 h-28 bg-white/10 rounded-full flex items-center justify-center">
                        <canvas id="confidenceDonut" width="96" height="96" aria-label="Confidence Donut"></canvas>
                </div>
                </div>
            </div>
        </div>

        <!-- KPIs -->
        <div class="p-6 bg-white">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                <!-- Processing Time -->
                <div class="text-center bg-blue-50 rounded-xl p-6">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-clock text-2xl text-blue-600"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-2">Processing Time</h3>
                    <p class="text-2xl font-bold text-blue-600">{{ processing_time|floatformat:3|default:"0.234" }}s</p>
                    <p class="text-sm text-gray-500 mt-1">ML Model Analysis Speed</p>
                </div>

                <!-- Risk Level -->
                <div class="text-center {% if result == 'Fraud' %}bg-red-50{% else %}bg-green-50{% endif %} rounded-xl p-6">
                    <div class="w-16 h-16 {% if result == 'Fraud' %}bg-red-100{% else %}bg-green-100{% endif %} rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-shield-alt text-2xl {% if result == 'Fraud' %}text-red-600{% else %}text-green-600{% endif %}"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-2">Risk Level</h3>
                    <p class="text-2xl font-bold {% if result == 'Fraud' %}text-red-600{% else %}text-green-600{% endif %}">
                        {% if result == 'Fraud' %}🔴 HIGH{% else %}🟢 LOW{% endif %}
                    </p>
                    <p class="text-sm text-gray-500 mt-1">ML Model Assessment</p>
                </div>
                
                <!-- Analysis Date -->
                <div class="text-center bg-purple-50 rounded-xl p-6">
                    <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-calendar text-2xl text-purple-600"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-2">Analysis Date</h3>
                    <p class="text-lg font-bold text-purple-600">
                        {% if prediction %}{{ prediction.created_at|date:"M d, Y" }}{% else %}{{ "now"|date:"M d, Y" }}{% endif %}
                    </p>
                    <p class="text-sm text-gray-500">
                        {% if prediction %}{{ prediction.created_at|time:"H:i" }}{% else %}{{ "now"|time:"H:i" }}{% endif %}
                    </p>
                </div>
            </div>

            <!-- Risk Factors Analysis - Only Show for Fraud Cases -->
            {% if result == 'Fraud' and risk_factors %}
            <div class="bg-yellow-50 rounded-xl p-6 mb-8 border border-yellow-200">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center mr-4">
                        <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900">ML Model Risk Factor Analysis</h3>
                </div>
                <!-- Summary chips -->
                <div class="flex flex-wrap gap-2 mb-4">
                    {% for factor in risk_factors %}
                    <span class="px-3 py-1 rounded-full text-xs font-semibold {% if factor.risk_level == 'HIGH' %}bg-red-100 text-red-700{% elif factor.risk_level == 'MEDIUM' %}bg-yellow-100 text-yellow-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                        {{ factor.factor }}: {{ factor.risk_level }}
                    </span>
                    {% endfor %}
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for factor in risk_factors %}
                    <div class="bg-white rounded-lg p-4 border border-yellow-200 hover:shadow-md transition">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-gray-900">{{ factor.factor }}</h4>
                            <span class="px-2 py-1 rounded-full text-xs font-semibold
                                {% if factor.risk_level == 'HIGH' %}bg-red-100 text-red-800
                                {% elif factor.risk_level == 'MEDIUM' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-blue-100 text-blue-800{% endif %}">
                                {{ factor.risk_level }}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">{{ factor.description }}</p>
                        <p class="text-xs font-semibold text-red-600">{{ factor.impact }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Feature Importance -->
            {% if feature_importance %}
            <div class="bg-blue-50 rounded-xl p-6 mb-8 border border-blue-200">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                        <i class="fas fa-chart-bar text-blue-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900">ML Model Feature Importance</h3>
                </div>
                    <div class="bg-white rounded-lg p-4 border border-blue-200">
                    <canvas id="featChart" height="180"></canvas>
                </div>
            </div>
            {% endif %}

            <!-- Input Data Review -->
            {% if prediction %}
            <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900 mb-6">
                    <i class="fas fa-list mr-3 text-blue-500"></i>Analyzed Data Points
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for key, value in prediction.input_dict.items %}
                        <div class="bg-white rounded-lg p-4 border border-gray-200 hover:shadow-md transition">
                            <div class="text-sm font-medium text-gray-500 mb-1">{{ key|title }}</div>
                            <div class="text-base font-semibold text-gray-900">{{ value }}</div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="flex flex-wrap gap-3 justify-center mb-4">
        <button id="printResult" class="inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium rounded-lg border border-gray-200 transition">
            <i class="fas fa-print mr-2"></i>Print
        </button>
        {% if prediction %}
        <button id="downloadJson" class="inline-flex items-center px-4 py-2 bg-white hover:bg-gray-50 text-gray-800 font-medium rounded-lg border border-gray-200 transition">
            <i class="fas fa-download mr-2"></i>Download Case JSON
        </button>
        {% endif %}
    </div>

    <!-- Enhanced Recommendation Card -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-8">
        <h3 class="text-xl font-semibold text-gray-900 mb-6">
            <i class="fas fa-lightbulb mr-3 text-yellow-500"></i>ML Model Recommendations & Next Steps
        </h3>
        <div class="space-y-6">
            {% if result == 'Fraud' %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex items-start space-x-4 p-4 bg-red-50 rounded-lg border border-red-200">
                        <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fas fa-exclamation text-red-600"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">🚨 Immediate Action Required</h4>
                            <p class="text-gray-700 text-sm">ML Model detected multiple high-risk indicators. This claim requires immediate attention from your fraud investigation team.</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start space-x-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                        <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fas fa-search text-yellow-600"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">🔍 Additional Investigation</h4>
                            <p class="text-gray-700 text-sm">Verify documentation, contact witnesses, and review claim history thoroughly based on ML model analysis.</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start space-x-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fas fa-file-alt text-blue-600"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">📋 Document Everything</h4>
                            <p class="text-gray-700 text-sm">Keep detailed records of your investigation process and findings for legal purposes.</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start space-x-4 p-4 bg-orange-50 rounded-lg border border-orange-200">
                        <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fas fa-phone text-orange-600"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">📞 Contact Authorities</h4>
                            <p class="text-gray-700 text-sm">Consider contacting relevant authorities if fraud is confirmed based on ML model analysis.</p>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex items-start space-x-4 p-4 bg-green-50 rounded-lg border border-green-200">
                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fas fa-check text-green-600"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">✅ Standard Processing</h4>
                            <p class="text-gray-700 text-sm">ML Model analysis indicates this claim can proceed through normal processing channels without additional review.</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start space-x-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fas fa-clipboard-check text-blue-600"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">📋 Routine Verification</h4>
                            <p class="text-gray-700 text-sm">Continue with standard verification procedures as per company policy based on ML model assessment.</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start space-x-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fas fa-history text-purple-600"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">📊 Monitor for Patterns</h4>
                            <p class="text-gray-700 text-sm">Keep tracking for any unusual patterns in future claims from this policyholder.</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start space-x-4 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                        <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fas fa-chart-line text-indigo-600"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">📈 Update Records</h4>
                            <p class="text-gray-700 text-sm">Update customer records and maintain accurate claim history for future reference.</p>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-4 justify-center">
        <a href="{% url 'predict' %}" 
           class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
            <i class="fas fa-plus mr-3"></i>Analyze New Claim
        </a>
        
        <a href="{% url 'home' %}" 
           class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-semibold rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
            <i class="fas fa-history mr-3"></i>View Analysis History
        </a>
        
        <a href="{% url 'user_reports' %}" 
           class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
            <i class="fas fa-download mr-3"></i>Generate Report
        </a>
        
        <a href="{% if user.is_staff %}{% url 'admin_dashboard' %}{% else %}{% url 'dashboard' %}{% endif %}" 
           class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-semibold rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
            <i class="fas fa-home mr-3"></i>Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const donutEl = document.getElementById('confidenceDonut');
    if (donutEl) {
        const ctx = donutEl.getContext('2d');
        const confidence = parseFloat('{{ confidence_score|default:"95.0" }}');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Confidence', 'Remaining'],
                datasets: [{
                    data: [confidence, Math.max(0, 100 - confidence)],
                    backgroundColor: ['#ffffff', 'rgba(255,255,255,0.2)'],
                    borderWidth: 0
                }]
            },
            options: {
                cutout: '70%',
                plugins: { legend: { display: false } }
            }
        });
    }

    // Feature importance bar chart
    const featEl = document.getElementById('featChart');
    if (featEl) {
        const fctx = featEl.getContext('2d');
        const raw = {% if feature_importance %}{
            {% for k, v in feature_importance.items %}
            "{{ k|escapejs }}": {{ v|floatformat:"6" }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        }{% else %}{}{% endif %};
        const pairs = Object.entries(raw).sort((a,b)=> b[1]-a[1]).slice(0, 10);
        const labels = pairs.map(p => p[0]);
        const values = pairs.map(p => p[1]);
        new Chart(fctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Importance',
                    data: values,
                    backgroundColor: '#3b82f6'
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // Quick actions
    const printBtn = document.getElementById('printResult');
    if (printBtn) printBtn.addEventListener('click', () => window.print());
    const dlBtn = document.getElementById('downloadJson');
    if (dlBtn) {
        dlBtn.addEventListener('click', () => {
            const data = {% if prediction %}{{ prediction.input_data|safe }}{% else %}{}{% endif %};
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'claim_case.json';
            a.click();
            URL.revokeObjectURL(url);
        });
    }
</script>
{% endblock %}
